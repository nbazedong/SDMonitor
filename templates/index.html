<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SD-æœºå™¨-ç›‘æ§é¢æ¿</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .server {
            margin-bottom: 20px;
        }
        .progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border: 1px solid #ccc;
            border-radius: 5px;
            height: 20px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #4caf50;
            width: 0%;
            text-align: center;
            color: white;
            line-height: 20px;
        }
        button {
            margin-top: 5px;
            padding: 5px 10px;
            border: none;
            background-color: #007BFF;
            color: white;
            cursor: pointer;
            border-radius: 5px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        #servers {
            margin-top: 20px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .server-button {
            padding: 5px 10px;
            font-size: 14px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .server-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>SD-æœºå™¨-ç›‘æ§é¢æ¿</h1>
    <div id="servers"></div>

    <script>
        const urlMap = {
                        '101': 'http://192.168.14.101:17860',
                        '102': 'http://192.168.14.102:17860',
                        '115': 'http://192.168.14.115:17860',
                        '105': 'http://192.168.14.105:17860',
                        '241-4090': 'http://192.168.14.241:17860',
                        'å¹¿å‘Šè®¾è®¡': 'http://192.168.14.7:17860',
                        'è§’è‰²åŸç”»': 'http://10.6.29.52:17860',
                        'åœºæ™¯åŸç”»': 'http://10.6.29.59.7:17860'
                    };

        const statusPriority = { 'è¿ç®—ä¸­ğŸ’»': 1, 'ç©ºé—²ğŸŸ¡': 2, 'ç¦»çº¿âŒ': 3 };

        function redirectToServer(sign) {
            const url = urlMap[sign];
            if (url) window.open(url, '_blank');
        }

        function generateServerHTML(server, progress, status) {
            const progressBarWidth = status === "è¿ç®—ä¸­ğŸ’»" ? `${progress * 100}%` : '0%';
            const progressText = status === "è¿ç®—ä¸­ğŸ’»" ? `${(progress * 100).toFixed(1)}%` : '';

            return `
                <div class="server">
                    <div class="server-header">
                        <h3>${server} | ${status}</h3>
                        <button class="server-button" onclick="redirectToServer('${server}')">è®¿é—®SD-WEB</button>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${progressBarWidth};">
                            ${progressText}
                        </div>
                    </div>
                </div>
            `;
        }

        let refreshInterval = 5000; // åˆå§‹ä¸º5ç§’
        let intervalId;

        function fetchServerStatus() {
            $.get('/server_status', function (data) {
                const serversDiv = $('#servers');
                serversDiv.empty();

                const serversArray = Object.keys(data).map(server => {
                    const status = server.includes("ç¦»çº¿")
                        ? "ç¦»çº¿âŒ"
                        : (server.includes("è¿ç®—ä¸­") ? "è¿ç®—ä¸­ğŸ’»" : "ç©ºé—²ğŸŸ¡");

                    return {
                        server,
                        progress: data[server],
                        status
                    };
                });

                serversArray.sort((a, b) => statusPriority[a.status] - statusPriority[b.status]);

                const htmlContent = serversArray.map(({ server, progress, status }) =>
                    generateServerHTML(server.split(' | ')[0], progress, status)
                ).join('');

                serversDiv.html(htmlContent);

                // åŠ¨æ€è°ƒæ•´åˆ·æ–°é¢‘ç‡
                const hasRunningServers = serversArray.some(s => s.status === "è¿ç®—ä¸­ğŸ’»");
                const newInterval = hasRunningServers ? 1000 : 5000;

                if (refreshInterval !== newInterval) {
                    refreshInterval = newInterval;
                    clearInterval(intervalId);
                    intervalId = setInterval(fetchServerStatus, refreshInterval);
                }
            }).fail(function (error) {
                console.error("Error fetching server status:", error);
            });
        }

        intervalId = setInterval(fetchServerStatus, refreshInterval); // åˆå§‹åˆ·æ–°
        fetchServerStatus(); // ç«‹å³è·å–ä¸€æ¬¡çŠ¶æ€

    </script>
</body>
</html>
